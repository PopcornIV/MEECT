{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<h1 style="color:#2a7a3d;">üì¶ Upload Event Gallery</h1>

<form id="uploadForm" method="post" enctype="multipart/form-data" style="margin-top:20px;">
  {% csrf_token %}

  <div style="background:#fff; padding:20px; border-radius:8px; box-shadow:0 3px 10px rgba(0,0,0,0.08); max-width:600px;">
    <div style="margin-bottom:16px;">
      <label for="id_event_name" style="font-weight:600; color:#2a7a3d;">Event Name</label><br>
      {{ form.event_name }}
    </div>

    <div id="dropzone"
         style="border:2px dashed #2a7a3d; border-radius:8px; padding:40px; text-align:center; color:#555; cursor:pointer; transition:0.3s ease;">
      <p>üñºÔ∏è Drag and drop your ZIP file here, or click to select</p>
      <input type="file" id="id_zip_file" name="zip_file" accept=".zip" style="display:none;" />
      <p id="file-name" style="font-size:0.9rem; color:#2a7a3d; margin-top:10px;"></p>
    </div>

    <!-- Progress bar -->
    <div id="progressContainer" style="margin-top:20px; display:none;">
      <div style="background:#eee; height:10px; border-radius:6px; width:100%;">
        <div id="progressBar" style="
          height:10px;
          width:0%;
          background:#2a7a3d;
          border-radius:6px;
          transition:width 0.3s ease;">
        </div>
      </div>
      <p id="progressText" style="color:#333; margin-top:8px; font-size:0.9rem;">Uploading...</p>
    </div>

    <div style="margin-top:20px;">
      <button type="submit" class="button" style="background:#2a7a3d;color:#fff;border:none;padding:10px 18px;border-radius:4px;">
        Upload ZIP
      </button>
      <a href=".." class="button" style="margin-left:10px;background:#ccc;color:#333;">Cancel</a>
    </div>
  </div>
</form>

<script>
  const dropzone = document.getElementById('dropzone');
  const input = document.getElementById('id_zip_file');
  const fileName = document.getElementById('file-name');
  const form = document.getElementById('uploadForm');
  const progressContainer = document.getElementById('progressContainer');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');

  // Drag & drop handlers
  dropzone.addEventListener('click', () => input.click());

  dropzone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropzone.style.background = '#e9f2eb';
  });

  dropzone.addEventListener('dragleave', () => {
    dropzone.style.background = '#fff';
  });

  dropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropzone.style.background = '#fff';
    const file = e.dataTransfer.files[0];
    if (file && file.name.endsWith('.zip')) {
      input.files = e.dataTransfer.files;
      fileName.textContent = `‚úÖ Selected: ${file.name}`;
    } else {
      fileName.textContent = '‚ùå Please upload a valid .zip file';
    }
  });

  input.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) fileName.textContent = `‚úÖ Selected: ${file.name}`;
  });

  // Upload progress
  form.addEventListener('submit', function (e) {
    e.preventDefault();
    const formData = new FormData(form);
    progressContainer.style.display = "block";

    const xhr = new XMLHttpRequest();
    xhr.open("POST", window.location.href, true);

    xhr.upload.onprogress = function (e) {
      if (e.lengthComputable) {
        const percent = (e.loaded / e.total) * 100;
        progressBar.style.width = percent + "%";
        progressText.textContent = "Uploading... " + Math.round(percent) + "%";
      }
    };

    xhr.onload = function () {
      if (xhr.status === 200) {
        progressText.textContent = "‚úÖ Upload complete! Extracting images...";
        setTimeout(() => {
          window.location.href = "../";
        }, 1500);
      } else {
        progressText.textContent = "‚ùå Upload failed. Please try again.";
      }
    };

    xhr.onerror = function () {
      progressText.textContent = "‚ùå An error occurred during upload.";
    };

    xhr.send(formData);
  });
</script>
{% endblock %}
